name: Branch Cleanup

on:
  workflow_dispatch: {}
#  schedule:
#    - cron:  '0 0 * * 0'  # This means every Sunday at 00:00

jobs:
  branch-cleanup:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Run script
      run: |
        echo "Checking branches..."
        branches=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -s "https://api.github.com/repos/${{ github.repository }}/branches" | jq -r '. | .[] | .name')
        fifteen_minutes_ago=$(date -u -d'15 minutes ago' +%Y-%m-%dT%H:%M:%SZ)
        for branch in $branches; do
          echo "Checking branch $branch..."
          last_commit_date=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                             -s "https://api.github.com/repos/${{ github.repository }}/commits/$branch" | jq -r '.commit.author.date')
          echo "Last commit date: $last_commit_date"
          echo "Fifteen minutes ago: $fifteen_minutes_ago"
          if [[ "$last_commit_date" < "$fifteen_minutes_ago" ]]; then
            echo "Branch $branch is stale"
          fi
        done
